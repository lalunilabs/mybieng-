"use strict";(()=>{var e={};e.id=332,e.ids=[332],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14983:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>v,patchFetch:()=>N,requestAsyncStorage:()=>h,routeModule:()=>y,serverHooks:()=>R,staticGenerationAsyncStorage:()=>x});var r={};s.r(r),s.d(r,{DELETE:()=>f,POST:()=>m,dynamic:()=>b});var a=s(49303),n=s(88716),i=s(60670),o=s(87070),u=s(53524),l=s(65630),c=s(29489),d=s(35860);let p=new u.PrismaClient,w=l.Ry({email:l.Z_().email("Invalid email address"),preferences:l.Ry({weeklyInsights:l.O7().default(!0),newQuizzes:l.O7().default(!0),researchUpdates:l.O7().default(!1)}).default({weeklyInsights:!0,newQuizzes:!0,researchUpdates:!1}),source:l.Z_().optional(),leadMagnet:l.Z_().optional(),firstName:l.Z_().optional(),lastName:l.Z_().optional()});async function m(e){try{await d.Yy.check(e,5);let t=await e.json(),{email:s,preferences:r,source:a,leadMagnet:n,firstName:i,lastName:u}=w.parse(t),l=await p.newsletter.findUnique({where:{email:s}});if(l)return await p.newsletter.update({where:{email:s},data:{preferences:JSON.stringify(r),source:a||l.source,leadMagnet:n||l.leadMagnet,updatedAt:new Date}}),o.NextResponse.json({success:!0,message:"Preferences updated successfully",isNewSubscriber:!1});let c=await p.newsletter.create({data:{email:s,firstName:i,lastName:u,preferences:JSON.stringify(r),source:a||"website",leadMagnet:n,isActive:!0,confirmedAt:new Date}});try{await g(s,{firstName:i,leadMagnet:n,preferences:r})}catch(e){console.error("Failed to send welcome email:",e)}try{await p.analytics.create({data:{event:"newsletter_signup",sessionId:e.headers.get("x-session-id")||"unknown",data:JSON.stringify({email:s.split("@")[1],source:a,leadMagnet:n,preferences:r})}})}catch(e){console.error("Failed to track newsletter signup:",e)}return o.NextResponse.json({success:!0,message:"Successfully subscribed to newsletter",isNewSubscriber:!0,subscriptionId:c.id})}catch(e){if(console.error("Newsletter subscription error:",e),e instanceof c.j)return o.NextResponse.json({error:"Invalid subscription data",details:e.format()},{status:400});if(e.message?.includes("Rate limit exceeded"))return o.NextResponse.json({error:"Too many subscription attempts",message:"Please wait before trying again."},{status:429});return o.NextResponse.json({error:"Failed to subscribe to newsletter",message:"Please try again later."},{status:500})}finally{await p.$disconnect()}}async function f(e){try{let{searchParams:t}=new URL(e.url),s=t.get("email");if(t.get("token"),!s)return o.NextResponse.json({error:"Email is required"},{status:400});if(!await p.newsletter.findUnique({where:{email:s}}))return o.NextResponse.json({error:"Subscription not found"},{status:404});await p.newsletter.update({where:{email:s},data:{isActive:!1,unsubscribedAt:new Date}});try{await p.analytics.create({data:{event:"newsletter_unsubscribe",data:JSON.stringify({email:s.split("@")[1],reason:"user_request"})}})}catch(e){console.error("Failed to track unsubscribe:",e)}return o.NextResponse.json({success:!0,message:"Successfully unsubscribed from newsletter"})}catch(e){return console.error("Newsletter unsubscribe error:",e),o.NextResponse.json({error:"Failed to unsubscribe"},{status:500})}finally{await p.$disconnect()}}async function g(e,t){console.log("Would send welcome email:",{to:e,subject:t.leadMagnet?`Your free guide: ${t.leadMagnet}`:"Welcome to MyBeing!",template:"welcome",data:{firstName:t.firstName||"Friend",leadMagnet:t.leadMagnet,preferences:t.preferences,unsubscribeUrl:`http://localhost:3000/unsubscribe?email=${encodeURIComponent(e)}`}})}let b="force-dynamic",y=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/newsletter/subscribe/route",pathname:"/api/newsletter/subscribe",filename:"route",bundlePath:"app/api/newsletter/subscribe/route"},resolvedPagePath:"/Users/niharikasai/mybeing/app/api/newsletter/subscribe/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:x,serverHooks:R}=y,v="/api/newsletter/subscribe/route";function N(){return(0,i.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:x})}},35860:(e,t,s)=>{s.d(t,{Yy:()=>n});var r=s(10138);function a(e){let t=new r.z({max:e?.uniqueTokenPerInterval||500,ttl:e?.interval||6e4});return{check:(e,s,r)=>{let a=e.ip||"127.0.0.1",n=r||a,i=t.get(n)||[0];i[0]+=1,t.set(n,i);let o=i[0],u=o>s,l=new Headers;if(l.set("X-RateLimit-Limit",s.toString()),l.set("X-RateLimit-Remaining",u?"0":(s-o).toString()),u){let e=Math.ceil((t.getRemainingTTL(n)||0)/1e3);throw l.set("Retry-After",e.toString()),Error(`Rate limit exceeded. Try again in ${e} seconds.`)}return{limit:s,remaining:s-o,success:!0}}}}let n=a({interval:6e4,uniqueTokenPerInterval:500});a({interval:6e4,uniqueTokenPerInterval:1e3})}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[8948,5972,5630,138],()=>s(14983));module.exports=r})();