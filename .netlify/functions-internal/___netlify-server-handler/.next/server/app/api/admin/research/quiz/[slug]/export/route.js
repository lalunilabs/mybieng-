"use strict";(()=>{var e={};e.id=2722,e.ids=[2722],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},52401:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g});var n={};r.r(n),r.d(n,{GET:()=>d});var a=r(49303),s=r(88716),i=r(60670),o=r(87070),u=r(52663),l=r(6659),c=r(4745);async function d(e,{params:t}){try{let r=e.cookies.get("admin_token")?.value,n=r?await (0,l.Wg)(r):null;if(!n||n.email!==process.env.OWNER_EMAIL)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:a}=new URL(e.url),s=a.get("timeRange"),i=(a.get("format")||"json").toLowerCase(),d=function(e){let t=new Date;switch(e){case"24h":{let e=new Date(t);return e.setDate(t.getDate()-1),e}case"7d":{let e=new Date(t);return e.setDate(t.getDate()-7),e}case"30d":{let e=new Date(t);return e.setDate(t.getDate()-30),e}case"90d":{let e=new Date(t);return e.setDate(t.getDate()-90),e}default:return null}}(s),p=t.slug,m={quizSlug:p};d&&(m.createdAt={gte:d});let g=await (0,u.s)(()=>u._.quizRun.findMany({where:m,select:{id:!0,quizSlug:!0,total:!0,bandLabel:!0,createdAt:!0},orderBy:{createdAt:"asc"}}),[]);if("json"===i){let e=g.map(e=>e.id),t=await (0,u.s)(()=>u._.quizAnswer.findMany({where:{runId:{in:e}},select:{runId:!0,question:!0,value:!0}}),[]),r={};t.forEach(e=>{r[e.runId]||(r[e.runId]=[]),r[e.runId].push({question:e.question,value:e.value})});let n=(0,c.em)(p),a={quiz:n?{slug:n.slug,title:n.title,description:n.description,imageUrl:n.imageUrl||"",attachments:n.attachments||[],tags:n.tags||[],published:!1!==n.published,publishedAt:n.publishedAt||null,questions:(n.questions||[]).map(e=>({id:e.id,text:e.text,type:e.type,options:e.options||[],imageUrl:e.imageUrl||"",attachments:e.attachments||[]})),bands:n.bands||[]}:{slug:p,title:p,description:"",imageUrl:"",attachments:[],tags:[],published:!0,publishedAt:null,questions:[],bands:[]},responses:g.map(e=>({response_id:e.id,quiz_slug:e.quizSlug,completed_at:e.createdAt,total_score:e.total,band_result:e.bandLabel,answers:r[e.id]||[]}))};return new o.NextResponse(JSON.stringify(a,null,2),{headers:{"Content-Type":"application/json","Content-Disposition":`attachment; filename="${p}-research-${Date.now()}.json"`}})}{let e=g.map(e=>e.id),t=await (0,u.s)(()=>u._.quizAnswer.findMany({where:{runId:{in:e}},select:{runId:!0,question:!0,value:!0}}),[]),r=new Set;t.forEach(e=>r.add(e.question));let n=Array.from(r).map(e=>`q_${e}`),a=(0,c.em)(p),s=(a?.attachments||[]).map(e=>`${(e.label||"").replaceAll('"','"')}|${(e.url||"").replaceAll('"','"')}`).join(";"),i=g.map(e=>{let t={quiz_title:a?.title||p,quiz_attachments:s,response_id:e.id,quiz_slug:e.quizSlug,completed_at:e.createdAt.toISOString(),total_score:e.total,band_result:e.bandLabel};return n.forEach(e=>t[e]=""),t}),l={};g.forEach((e,t)=>l[e.id]=t),t.forEach(e=>{let t=l[e.runId];if(void 0!==t){let r=`q_${e.question}`;i[t][r]=e.value}});let d=function(e){if(!e.length)return"";let t=Object.keys(e[0]),r=[t.join(",")];for(let n of e){let e=t.map(e=>{let t=n[e];return'"'+(null==t?"":String(t)).replace(/"/g,'""')+'"'}).join(",");r.push(e)}return r.join("\n")}(i);return new o.NextResponse(d,{headers:{"Content-Type":"text/csv","Content-Disposition":`attachment; filename="${p}-research-${Date.now()}.csv"`}})}}catch(e){return console.error("Admin research export error:",e),o.NextResponse.json({error:"Failed to export data"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/research/quiz/[slug]/export/route",pathname:"/api/admin/research/quiz/[slug]/export",filename:"route",bundlePath:"app/api/admin/research/quiz/[slug]/export/route"},resolvedPagePath:"/Users/niharikasai/mybeing/app/api/admin/research/quiz/[slug]/export/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:f}=p,h="/api/admin/research/quiz/[slug]/export/route";function y(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},6659:(e,t,r)=>{r.d(t,{Wg:()=>g,p$:()=>p,v9:()=>m,vN:()=>f});var n=r(71615),a=r(41482),s=r.n(a),i=r(84770);let o={super_admin:["users.read","users.write","users.delete","content.read","content.write","content.delete","subscriptions.read","subscriptions.write","ai_chat.read","ai_chat.moderate","system.read","system.write","analytics.read","reports.read","reports.export","settings.read","settings.write","security.read","security.write","admin.manage"]},u=process.env.OWNER_EMAIL||"",l=process.env.ADMIN_PASSWORD||"",c=Number(process.env.ADMIN_SESSION_TIMEOUT||"86400"),d=Number.isFinite(c)&&c>0?1e3*c:864e5;class p extends Error{constructor(e,t){super(e),this.code=t,this.name="AdminAuthError"}}async function m(e,t){if(!u||!l)throw new p("Admin not configured","ADMIN_NOT_CONFIGURED");let r=Buffer.from(e),n=Buffer.from(u),a=Buffer.from(t),c=Buffer.from(l),m=r.length===n.length&&(0,i.timingSafeEqual)(r,n),g=a.length===c.length&&(0,i.timingSafeEqual)(a,c);if(!m||!g)throw new p("Invalid credentials","INVALID_CREDENTIALS");let f={id:"admin_owner",email:u,name:u.split("@")[0],role:"super_admin",permissions:o.super_admin,createdAt:new Date().toISOString(),lastLogin:new Date().toISOString()},h=s().sign({userId:f.id,email:f.email,role:f.role},function(){let e=process.env.ADMIN_JWT_SECRET;if(!e||e.length<16)throw new p("Admin not configured","ADMIN_NOT_CONFIGURED");return e}(),{expiresIn:`${Math.floor(d/1e3)}s`});return{user:f,token:h,expiresAt:new Date(Date.now()+d).toISOString()}}async function g(e){try{let t=process.env.ADMIN_JWT_SECRET;if(!t)return null;let r=s().verify(e,t);if(!r?.email||r.email!==u)return null;return{id:"admin_owner",email:u,name:u.split("@")[0],role:"super_admin",permissions:o.super_admin,createdAt:"2023-01-01T00:00:00Z",lastLogin:new Date().toISOString()}}catch(e){return null}}async function f(){try{let e=(0,n.cookies)(),t=e.get("admin_token")?.value;if(!t)return null;return await g(t)}catch(e){return null}}},52663:(e,t,r)=>{r.d(t,{_:()=>s,s:()=>i});let n=require("@prisma/client"),a=()=>({user:{findMany:async()=>[],findUnique:async()=>null,create:async e=>({id:"mock-user",...e}),count:async()=>0},quizRun:{findMany:async()=>[],findUnique:async()=>null,create:async e=>({id:"mock-run",...e}),count:async()=>0,update:async()=>({}),updateMany:async()=>({})},quizAnswer:{findMany:async()=>[],create:async e=>({id:"mock-answer",...e}),createMany:async()=>({count:0})},newsletter:{create:async e=>({id:"mock-subscriber",...e}),count:async()=>0},$connect:async()=>{},$disconnect:async()=>{},$transaction:async e=>e(void 0)}),s=globalThis.prisma??function(){if(!process.env.DATABASE_URL)return console.warn("No DATABASE_URL found - using mock client"),a();try{return new n.PrismaClient({log:["error"],datasources:{db:{url:process.env.DATABASE_URL}}})}catch(e){return console.error("Failed to create Prisma client:",e),a()}}();async function i(e,t){if(!s)return console.warn("Database not available - returning fallback value"),t;try{return await e()}catch(e){return console.error("Database operation failed:",e),t}}}};var t=require("../../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972,4261,4745],()=>r(52401));module.exports=n})();