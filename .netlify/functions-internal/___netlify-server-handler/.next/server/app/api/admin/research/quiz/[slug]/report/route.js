"use strict";(()=>{var e={};e.id=7921,e.ids=[7921],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},65134:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>y,requestAsyncStorage:()=>d,routeModule:()=>h,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m});var n={};r.r(n),r.d(n,{GET:()=>p});var s=r(49303),a=r(88716),i=r(60670),o=r(87070),u=r(52663),l=r(6659),c=r(4745);async function p(e,{params:t}){try{let r=e.cookies.get("admin_token")?.value,n=r?await (0,l.Wg)(r):null;if(!n||n.email!==process.env.OWNER_EMAIL)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:s}=new URL(e.url),a=s.get("timeRange"),i=function(e){let t=new Date;switch(e){case"24h":{let e=new Date(t);return e.setDate(t.getDate()-1),e}case"7d":{let e=new Date(t);return e.setDate(t.getDate()-7),e}case"30d":{let e=new Date(t);return e.setDate(t.getDate()-30),e}case"90d":{let e=new Date(t);return e.setDate(t.getDate()-90),e}default:return null}}(a),p=t.slug,h={quizSlug:p};i&&(h.createdAt={gte:i});let d=await (0,u.s)(()=>u._.quizRun.findMany({where:h,select:{id:!0,total:!0,bandLabel:!0,createdAt:!0},orderBy:{createdAt:"asc"}}),[]),m=[],g=(0,c.em)(p),f=g?.title||p;if(m.push(`# Research Report: ${f}`),m.push(""),m.push(`Time Range: ${a||"all"}`),m.push(""),g?.imageUrl&&(m.push(`![Cover Image](${g.imageUrl})`),m.push("")),g?.attachments?.length&&(m.push("## Resources"),g.attachments.forEach(e=>{let t=e.label||e.url;m.push(`- [${t}](${e.url})`)}),m.push("")),0===d.length){m.push("_No data available for this selection._");let e=m.join("\n");return new o.NextResponse(e,{headers:{"Content-Type":"text/markdown; charset=utf-8","Content-Disposition":`attachment; filename="${p}-research-report-${Date.now()}.md"`}})}let y=d.length,w=d.reduce((e,t)=>e+(t.total||0),0)/d.length,A={};d.forEach(e=>{let t=e.bandLabel||"Unlabeled";A[t]=(A[t]||0)+1});let D={};d.forEach(e=>{let t=e.createdAt.toISOString().split("T")[0];D[t]=(D[t]||0)+1});let _=d.map(e=>e.id),x=await (0,u.s)(()=>u._.quizAnswer.findMany({where:{runId:{in:_}},select:{question:!0,value:!0}}),[]),q={};x.forEach(e=>{q[e.question]||(q[e.question]=[]),q[e.question].push(e.value)});let v=Object.entries(q);if(m.push("## Summary"),m.push(`- Total Completions: ${y}`),m.push(`- Average Score: ${w.toFixed(2)}`),m.push(""),m.push("## Score Distribution"),m.push("Band | Count"),m.push("---|---:"),Object.entries(A).forEach(([e,t])=>{m.push(`${e} | ${t}`)}),m.push(""),m.push("## Question Highlights"),0===v.length?m.push("_No question analytics available._"):v.slice(0,5).forEach(([e,t])=>{let r=t.reduce((e,t)=>e+t,0)/t.length;m.push(`- ${e}`),m.push(`  - Avg Response: ${r.toFixed(2)} (n=${t.length})`)}),m.push(""),g?.questions?.length){let e=g.questions.filter(e=>e.imageUrl||(e.attachments||[]).length);e.length&&(m.push("## Question Resources"),e.forEach((e,t)=>{m.push(`### Q${t+1}. ${e.text}`),e.imageUrl&&m.push(`![Question Image](${e.imageUrl})`),(e.attachments||[]).length&&(e.attachments||[]).forEach(e=>{let t=e.label||e.url;m.push(`- [${t}](${e.url})`)}),m.push("")}))}let E=Object.values(q).flat(),b=new Set(E).size,R=[];1===b&&E.length>0&&R.push("All respondents answered the same way"),R.length&&(m.push("## Response Patterns"),R.forEach(e=>m.push(`- ${e}`)),m.push("")),m.push("## Completion Trend (Daily)"),m.push("Date | Count"),m.push("---|---:"),Object.entries(D).sort(([e],[t])=>e.localeCompare(t)).slice(-14).forEach(([e,t])=>m.push(`${e} | ${t}`)),m.push(""),m.push("_Generated by MyBeing Research Tools_");let S=m.join("\n");return new o.NextResponse(S,{headers:{"Content-Type":"text/markdown; charset=utf-8","Content-Disposition":`attachment; filename="${p}-research-report-${Date.now()}.md"`}})}catch(e){return console.error("Admin research report error:",e),o.NextResponse.json({error:"Failed to generate report"},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/research/quiz/[slug]/report/route",pathname:"/api/admin/research/quiz/[slug]/report",filename:"route",bundlePath:"app/api/admin/research/quiz/[slug]/report/route"},resolvedPagePath:"/Users/niharikasai/mybeing/app/api/admin/research/quiz/[slug]/report/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:m,serverHooks:g}=h,f="/api/admin/research/quiz/[slug]/report/route";function y(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}},6659:(e,t,r)=>{r.d(t,{Wg:()=>m,p$:()=>h,v9:()=>d,vN:()=>g});var n=r(71615),s=r(41482),a=r.n(s),i=r(84770);let o={super_admin:["users.read","users.write","users.delete","content.read","content.write","content.delete","subscriptions.read","subscriptions.write","ai_chat.read","ai_chat.moderate","system.read","system.write","analytics.read","reports.read","reports.export","settings.read","settings.write","security.read","security.write","admin.manage"]},u=process.env.OWNER_EMAIL||"",l=process.env.ADMIN_PASSWORD||"",c=Number(process.env.ADMIN_SESSION_TIMEOUT||"86400"),p=Number.isFinite(c)&&c>0?1e3*c:864e5;class h extends Error{constructor(e,t){super(e),this.code=t,this.name="AdminAuthError"}}async function d(e,t){if(!u||!l)throw new h("Admin not configured","ADMIN_NOT_CONFIGURED");let r=Buffer.from(e),n=Buffer.from(u),s=Buffer.from(t),c=Buffer.from(l),d=r.length===n.length&&(0,i.timingSafeEqual)(r,n),m=s.length===c.length&&(0,i.timingSafeEqual)(s,c);if(!d||!m)throw new h("Invalid credentials","INVALID_CREDENTIALS");let g={id:"admin_owner",email:u,name:u.split("@")[0],role:"super_admin",permissions:o.super_admin,createdAt:new Date().toISOString(),lastLogin:new Date().toISOString()},f=a().sign({userId:g.id,email:g.email,role:g.role},function(){let e=process.env.ADMIN_JWT_SECRET;if(!e||e.length<16)throw new h("Admin not configured","ADMIN_NOT_CONFIGURED");return e}(),{expiresIn:`${Math.floor(p/1e3)}s`});return{user:g,token:f,expiresAt:new Date(Date.now()+p).toISOString()}}async function m(e){try{let t=process.env.ADMIN_JWT_SECRET;if(!t)return null;let r=a().verify(e,t);if(!r?.email||r.email!==u)return null;return{id:"admin_owner",email:u,name:u.split("@")[0],role:"super_admin",permissions:o.super_admin,createdAt:"2023-01-01T00:00:00Z",lastLogin:new Date().toISOString()}}catch(e){return null}}async function g(){try{let e=(0,n.cookies)(),t=e.get("admin_token")?.value;if(!t)return null;return await m(t)}catch(e){return null}}},52663:(e,t,r)=>{r.d(t,{_:()=>a,s:()=>i});let n=require("@prisma/client"),s=()=>({user:{findMany:async()=>[],findUnique:async()=>null,create:async e=>({id:"mock-user",...e}),count:async()=>0},quizRun:{findMany:async()=>[],findUnique:async()=>null,create:async e=>({id:"mock-run",...e}),count:async()=>0,update:async()=>({}),updateMany:async()=>({})},quizAnswer:{findMany:async()=>[],create:async e=>({id:"mock-answer",...e}),createMany:async()=>({count:0})},newsletter:{create:async e=>({id:"mock-subscriber",...e}),count:async()=>0},$connect:async()=>{},$disconnect:async()=>{},$transaction:async e=>e(void 0)}),a=globalThis.prisma??function(){if(!process.env.DATABASE_URL)return console.warn("No DATABASE_URL found - using mock client"),s();try{return new n.PrismaClient({log:["error"],datasources:{db:{url:process.env.DATABASE_URL}}})}catch(e){return console.error("Failed to create Prisma client:",e),s()}}();async function i(e,t){if(!a)return console.warn("Database not available - returning fallback value"),t;try{return await e()}catch(e){return console.error("Database operation failed:",e),t}}}};var t=require("../../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972,4261,4745],()=>r(65134));module.exports=n})();